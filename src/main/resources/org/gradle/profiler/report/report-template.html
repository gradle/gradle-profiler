<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Benchmark Results</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.12/vue.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.0.0-beta/chart.min.js'></script>
    <style type="text/css">
body {
    font-family: 'Lato', sans-serif;
    font-size: 12px;
}
#data-table {
    overflow-x: scroll;
}
th {
    font-size: larger;
    text-align: center;
}
.title {
    font-weight: bold;
}
.data {
    font-family: 'Roboto Mono', monospace;
    white-space: nowrap;
}
td.title div {
    width: 400px;
    overflow-x: scroll;
}
td .btn {
    font-size: 10px;
    padding: 0.2em 0.5em 0.2em 0.5em;
    float: right;
}
td.numeric {
    text-align: right;
    padding-left: 1em;
    padding-right: 1em;
}
td.diff {
    font-size: 9pt; color: #c0c0c0;
}
td.clickable {
    cursor: pointer;
}
td.clickable .selection-icon {
    width: 1em;
}
td.clickable:hover .selection-icon::before {
    content: "\f00c";
}
td.clickable .selection-icon.selected::before {
    content: "\f14a";
}
td.WARM_UP {
    background-color: #fff8ee;
}
tr:hover td.WARM_UP {
    background-color: #ffe6d4;
}
td.MEASURE {
    background-color: #eeffee;
}
tr:hover td.MEASURE {
    background-color: #d8ffd8;
}
div.controls > div.col-form-label {
    text-align: right;
}
footer {
    margin-top: 2em;
    padding: 1em;
    color: #aaa;
    background-color: #eee;
    font-size: smaller;
    text-align: right;
    border-top: 1px solid #ddd;
}
    </style>
</head>
<body>
<div id="app">
<nav class="navbar navbar-dark bg-dark">
<span class="navbar-brand mb-0 h1">Gradle Profiler – Benchmark results</span>
<div class="form-row controls">
    <div class="btn-group btn-group-toggle" data-toggle="buttons">
        <label class="btn btn-secondary" :class="{ active: options.order === 'historical' }">
            <input type="radio" name="order" v-model="options.order" value="historical"> Historical
        </label>
        <label class="btn btn-secondary" :class="{ active: options.order === 'sorted' }">
            <input type="radio" name="order" v-model="options.order" value="sorted"> Sorted
        </label>
    </div>
</div>
</nav>
<div class='container-fluid'>
<div class='row mt-3'>
    <div class='col ml-auto mr-auto'>
        <canvas id='samples' style="width: 100%; height: 400px;"></canvas>
    </div>
</div>
<div class="row mt-3">
    <div class='col ml-auto mr-auto'>
        <div id="data-table">
            <div class='row'>
                <div class='col'>
                    <table class='table table-sm table-hover'>
                        <thead>
                            <tr>
                                <th>Scenario</th>
                                <th>Sample</th>
                                <th>Mean</th>
                                <th>Min</th>
                                <th>P25</th>
                                <th>Median</th>
                                <th>P75</th>
                                <th>Max</th>
                                <th>Std.dev</th>
                                <th>Confidence</th>
                                <th :colspan="Math.max(...benchmarkResult.scenarios.map(scenario => scenario.iterations.length))">Builds</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template v-for="scenario in benchmarkResult.scenarios">
                                <template v-for="(sample, index) in scenario.samples">
                                    <tr>
                                        <td class="title" v-if="index === 0" :rowspan="scenario.samples.length">
                                            <div>
                                                <button class="btn btn-light" @click="console.log(scenario); scenario.showDetails = !scenario.showDetails"><i class="fa fa-ellipsis-h"></i></button>
                                                <span class="title">{{ scenario.definition.title }}</span>
                                                <ul v-show="scenario.showDetails">
                                                    <li>
                                                        <span class="description">Build tool:</span>
                                                        <span class="data">{{ scenario.definition.buildTool }}</span>
                                                    </li>
                                                    <li>
                                                        <span class="description">Tasks:</span>
                                                        <span class="data">{{ scenario.definition.tasks }}</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </td>
                                        <td class="clickable data" @click="select(sample)" :style="{ color: sample.color }">
                                            <span class="fa selection-icon" :class="{ selected: sample.selected }" :style="{ color: sample.color }"></span>
                                            <span>{{ sample.name }}</span>
                                        </td>
                                        <td class="numeric data">{{ calc('mean', sample, scenario) | numeric }}</td>
                                        <td class="numeric data">{{ calc('p25', sample, scenario) | numeric }}</td>
                                        <td class="numeric data">{{ calc('min', sample, scenario) | numeric }}</td>
                                        <td class="numeric data">{{ calc('median', sample, scenario) | numeric }}</td>
                                        <td class="numeric data">{{ calc('p75', sample, scenario) | numeric }}</td>
                                        <td class="numeric data">{{ calc('max', sample, scenario) | numeric }}</td>
                                        <td class="numeric data">{{ calc('stddev', sample, scenario) | numeric }}</td>
                                        <td class="numeric data">{{ sample.confidence | percent }}</td>
                                        <template v-for="iteration in scenario.iterations">
                                            <td class="numeric data" :class="iteration.phase" :title="iteration.phase + ' #' + iteration.iteration">{{ iteration.values[sample.name] | numeric }}</td>
                                        </template>
                                    </tr>
                                </template>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<footer>
    <span>Gradle Profiler version {{ benchmarkResult.environment.profilerVersion }}</span>
</footer>
</div>
<script>
const Phase = {
    WARM_UP: "WARM_UP",
    MEASURE: "MEASURE"
};

const benchmarkResult =
@@BENCHMARK_RESULT_JSON@@
;

Array.prototype.numericSort = function() {
    return this.slice().sort((a, b) => a - b);
}
Array.prototype.reverseNumericSort = function() {
    return this.slice().sort((a, b) => b - a);
}
Array.prototype.min = function() {
    return Math.min(...this);
}
Array.prototype.mean = function() {
    return this.reduce((sum, val) => sum + val) / this.length;
}
Array.prototype.max = function() {
    return Math.max(...this);
}
Array.prototype.quantile = function(q) {
    const sorted = this.numericSort();
    const pos = (sorted.length - 1) * q;
    const base = Math.floor(pos);
    const rest = pos - base;
    if (sorted[base + 1] !== undefined) {
        return sorted[base] + rest * (sorted[base + 1] - sorted[base]);
    } else {
        return sorted[base];
    }
}
Array.prototype.stddev = function() {
    const mean = this.mean();
    return Math.sqrt(this.map(x => Math.pow(x - mean, 2)).mean());
}
const millisecondFormat = new Intl.NumberFormat(navigator.language, {style: 'unit', unit: 'millisecond', unitDisplay: 'short', minimumFractionDigits: 2, maximumFractionDigits: 2});

function measuredIterations(scenario) {
    return scenario.iterations.filter(iteration => iteration.phase === Phase.MEASURE);
}

const OPERATIONS = {
    "mean": (data) => data.mean(),
    "min": (data) => data.min(),
    "max": (data) => data.max(),
    "p25": (data) => data.quantile(.25),
    "median": (data) => data.quantile(.50),
    "p75": (data) => data.quantile(.75),
    "stddev": (data) => data.stddev()
};

new Vue({
    el: '#app',
    data: {
        options: {
            order: "historical"
        },
        benchmarkResult: benchmarkResult
    },
    computed: {
        chartData: function() {
            const sorted = this.options.order === "sorted";
            return this.benchmarkResult.scenarios
                .map(scenario => scenario.samples
                    .filter(sample => sample.selected)
                    .map(sample => {
                        let data = measuredIterations(scenario)
                            .map(iteration => iteration.values[sample.name]);
                        if (sorted) {
                            data = data.reverseNumericSort();
                        }
                        return {
                            label: sample.name,
                            showLine: true,
                            stepped: "middle",
                            pointRadius: 0,
                            pointHitRadius: 10,
                            hoverRadius: 6,
                            fill: false,
                            borderWidth: sample.thickness,
                            backgroundColor: sample.color,
                            pointBackgroundColor: sample.color,
                            borderColor: sample.color,
                            data: data
                        };
                    }))
                .flat();
        }
    },
    watch: {
        "options.order": "updateData"
    },
    methods: {
        calc: (operation, sample, scenario) => {
            const data = measuredIterations(scenario)
                .map(iteration => iteration.values[sample.name]);
            return OPERATIONS[operation](data);
        },
        select: function(sample) {
            sample.selected = !sample.selected;
            this.updateData();
        },
        updateData: function() {
            this.chart.data.datasets = this.chartData;
            this.chart.update();
        }
    },
    filters: {
        "numeric": (value) => millisecondFormat.format(value),
        "percent": (value) => (value * 100).toFixed(2) + "%"
    },
    beforeCreate: function() {
        // Initialize sample config
        benchmarkResult.scenarios.forEach((scenario, scenarioIndex, scenarios) => {
            scenario.showDetails = false;
            scenario.samples.forEach((sample, sampleIndex, samples) => {
                sample.color = `hsl(${scenarioIndex * 360 / scenarios.length}, ${100 - 80 * sampleIndex / samples.length}%, ${30 + 40 * sampleIndex / samples.length}%)`;
                sample.thickness = sampleIndex === 0 ? 3 : 2;
                sample.selected = sampleIndex === 0;
            });
        });
    },
    mounted: function() {
        const ctx = document.getElementById('samples').getContext('2d');
        const maxMeasuredIterations = benchmarkResult.scenarios
            .map(scenario => measuredIterations(scenario).length)
            .max();
        this.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from(Array(maxMeasuredIterations), (_, i) => (i + 1).toString()),
                datasets: this.chartData
            },
            options: {
                font: {
                    family: "Roboto Mono"
                },
                plugins: {
                    crosshair: {
                        zoom: {
                            enabled: false
                        },
                        snap: {
                            enabled: false
                        }
                    }
                },
                responsive: false,
                animation: {
                    duration: 0
                },
                legend: {
                    position: "bottom",
                    align: "start",
                    fullWidth: false
                },
                tooltips: {
                    mode: "index",
                    position: "nearest",
                    itemSort: (a, b) => b.yLabel - a.yLabel,
                    callbacks: {
                        title: (tooltips, data) => `Build #${tooltips[0].label}`,
                        label: (context) => millisecondFormat.format(context.dataPoint.y) + " – " + context.dataset.label
                    }
                },
                hover: {
                    intersect: false
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
});
</script>
</body>
</html>
